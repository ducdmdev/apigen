# Contributing

Guide for developers who want to work on apigen itself.

## Prerequisites

- **Bun** (latest stable) -- used as the package manager and build tool.
- **Node.js 18+** -- required at runtime (set in `engines`).

## Setup

```bash
git clone <repo-url> && cd apigen
bun install
```

## Project structure

```
src/
  index.ts              Public entrypoint (re-exports defineConfig, resolveConfig, types)
  config.ts             Config resolution and defaults
  cli.ts                Commander-based CLI (apigen generate)
  loader.ts             Reads YAML/JSON specs, converts Swagger 2 to OpenAPI 3
  ir.ts                 Extracts an intermediate representation from a parsed spec
  discover.ts           Auto-discovers API specs at well-known paths
  writer.ts             Orchestrates generators and writes files to disk
  generators/
    types.ts            Emits TypeScript interfaces for schemas and params
    hooks.ts            Emits TanStack Query useQuery/useMutation hooks
    mocks.ts            Emits mock data constants
    provider.ts         Emits ApiTestModeProvider React context
    index-file.ts       Emits barrel index re-exporting all modules
  types/
    swagger2openapi.d.ts  Type declarations for swagger2openapi

tests/
  config.test.ts
  loader.test.ts
  ir.test.ts
  writer.test.ts
  cli.test.ts
  discover.test.ts
  e2e.test.ts
  generators/
    types.test.ts
    hooks.test.ts
    mocks.test.ts
    provider.test.ts
    api-fetch.test.ts
    index-file.test.ts
  fixtures/
    petstore-oas3.yaml
    petstore-swagger2.yaml
    inline-schemas.yaml
    tagged-api.yaml
    allof-composition.yaml
```

## Scripts

| Command              | Description                         |
|----------------------|-------------------------------------|
| `bun run test`       | Run all tests once (vitest run).    |
| `bun run test:watch` | Run tests in watch mode (vitest).   |
| `bun run typecheck`  | Type-check with `tsc --noEmit`.     |
| `bun run build`      | Bundle `src/cli.ts` to `dist/`.     |

## How the codebase is organized

The pipeline flows in one direction:

```
config --> loader --> IR --> generators --> writer --> CLI
```

1. **config** -- `resolveConfig` fills in defaults for any missing fields.
2. **loader** -- `loadSpec` reads a YAML or JSON file, detects Swagger 2 vs OpenAPI 3, converts Swagger 2 specs to OpenAPI 3 via `swagger2openapi`, and bundles `$ref`s with `@redocly/openapi-core`.
3. **IR** -- `extractIR` walks the parsed OpenAPI spec and produces a flat intermediate representation (`IR`) containing `operations` and `schemas`.
4. **generators** -- Pure functions that accept the IR (or no arguments) and return a string of TypeScript source code. Each generator produces one output file.
5. **writer** -- `writeGeneratedFiles` calls every generator and writes the results to the output directory.
6. **CLI** -- Wires the pipeline together behind `commander`. The `generate` command resolves paths, loads the spec, extracts the IR, and invokes the writer.

## How to add a new generator

1. Create a new file in `src/generators/`, for example `src/generators/client.ts`.
2. Export a function that accepts the IR (or a subset) and returns a `string`:

   ```ts
   import type { IR } from '../ir'

   function generateClient(ir: IR): string {
     const lines: string[] = []
     lines.push('/* eslint-disable */')
     lines.push('/* This file is auto-generated by apigen. Do not edit. */')
     lines.push('')
     // ... build output using template strings
     return lines.join('\n')
   }

   export { generateClient }
   ```

3. Import the generator in `src/writer.ts` and add a `writeFileSync` call:

   ```ts
   import { generateClient } from './generators/client'

   // inside writeGeneratedFiles:
   writeFileSync(join(outputDir, 'client.ts'), generateClient(ir), 'utf8')
   ```

4. Add a test file at `tests/generators/client.test.ts` that calls the generator with a minimal IR and asserts on the output string.

## Testing conventions

- **TDD** -- write or update tests before (or alongside) implementation changes.
- **Mirror structure** -- test files live under `tests/` and mirror the `src/` layout (e.g. `src/generators/types.ts` is tested by `tests/generators/types.test.ts`).
- **Vitest** -- all tests use `describe`, `it`, `expect` from `vitest`.
- **Fixture specs** -- integration and loader tests load real OpenAPI specs from `tests/fixtures/`.
- **Pure function tests** -- generator tests call the generator function directly and assert on the returned string with `toContain` / `toMatch`.

## Code style

- **Template-string generation** -- generators build output by pushing lines into a `string[]` array and joining with `'\n'`. No AST libraries are used.
- **Pure functions** -- generators have no side effects. They take data in and return a string out. Side effects (file I/O) are confined to `writer.ts` and `cli.ts`.
- **No AST manipulation** -- code generation is intentionally simple: concatenate string literals. This keeps generators easy to read and modify.
- **Strict TypeScript** -- the project uses `"strict": true` in `tsconfig.json`. All public interfaces are explicitly typed.
